tags: worker, calico

# 06-6. 部署 calico 网络

kubernetes 要求集群内各节点(包括 master 节点)能通过 Pod 网段互联互通。

calico 使用 IPIP 或 BGP 技术（默认为 IPIP）为各节点创建一个可以互通的 Pod 网络。

如果使用 flannel，请参考附件 [E.部署flannel网络.md](E.部署flannel网络.md)（flannel 与 docker 结合使用）

注意：如果没有特殊指明，本文档的所有操作均在 zhangjun-k8s01 节点上执行。

## 安装 calico 网络插件

``` bash
cd /opt/k8s/work
curl https://docs.projectcalico.org/manifests/calico.yaml -O
```

修改配置：

``` bash
$ cp calico.yaml calico.yaml.bak
$ diff calico.yaml.bak calico.yaml
630c630,632
<               value: "192.168.0.0/16"
---
>               value: "172.30.0.0/16"
>             - name: IP_AUTODETECTION_METHOD
>               value: "interface=eth.*"
699c701
<             path: /opt/cni/bin
---
>             path: /opt/k8s/bin
```
+ 将 Pod 网段地址修改为 `172.30.0.0/16`;
+ calico 自动探查互联网卡，如果有多快网卡，则可以配置用于互联的网络接口命名正则表达式，如上面的 `eth.*`(根据自己服务器的网络接口名修改)；

运行 calico 插件：

``` bash
$ kubectl apply -f  calico.yaml
```
+ calico 插架以 daemonset 方式运行在所有的 K8S 节点上。
+ 另外calico.yaml中描述的image都来自于`docker.io`，因此存在拉取不下来的情况，需要翻墙或者使用国内镜像。

## 查看 calico 运行状态

``` bash
[root@master137 work]# kubectl get pods -n kube-system -o wide
NAME                                       READY   STATUS    RESTARTS   AGE     IP                NODE        NOMINATED NODE   READINESS GATES
calico-kube-controllers-6566c5b7d8-5fq4m   1/1     Running   0          6m46s   172.30.36.65      master137   <none>           <none>
calico-node-ht84g                          1/1     Running   0          6m46s   192.168.182.137   master137   <none>           <none>
calico-node-kgfpr                          1/1     Running   0          6m46s   192.168.182.139   node139     <none>           <none>
calico-node-q9vj2                          1/1     Running   0          6m46s   192.168.182.138   node138     <none>           <none>
```

使用 crictl 命令查看 calico 使用的镜像，该命令类似`docker images`：

``` bash
$ crictl  images
IMAGE                                                     TAG                 IMAGE ID            SIZE
docker.io/calico/cni                                  v3.19.0             3d17cd6307a4f       48.3MB
docker.io/calico/kube-controllers                     v3.19.0             c51610d08fdf7       25MB
docker.io/calico/node                                 v3.19.0             b0744cc52c19a       55.2MB
docker.io/calico/pod2daemon-flexvol                   v3.19.0             a5decf77918d2       9.33MB
docker.io/library/nginx                               1.7.9               35d28df486f61       39.9MB
registry.aliyuncs.com/google_containers/pause-amd64   3.1                 da86e6ba6ca19       315kB
```
+ 如果 crictl 输出为空或执行失败，则有可能是缺少配置文件 `/etc/crictl.yaml` 导致的，该文件的配置如下：

    ``` yaml
    $ cat /etc/crictl.yaml
    runtime-endpoint: unix:///run/containerd/containerd.sock
    image-endpoint: unix:///run/containerd/containerd.sock
    timeout: 10
    debug: false
    ```